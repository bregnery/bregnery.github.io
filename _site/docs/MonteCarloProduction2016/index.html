<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Monte Carlo Production with the 2016 CMS Scheme</title>
    <meta name="description" content="General Steps for Monte Carlo Production">


    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">

    <link rel="shortcut icon" href="/favicon.ico?1">
    <!-- Begin Jekyll SEO tag v2.2.2 -->
<title>Monte Carlo Production with the 2016 CMS Scheme | Brendan Regnery</title>
<meta property="og:title" content="Monte Carlo Production with the 2016 CMS Scheme" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="General Steps for Monte Carlo Production" />
<meta property="og:description" content="General Steps for Monte Carlo Production" />
<link rel="canonical" href="http://localhost:4000/docs/MonteCarloProduction2016/" />
<meta property="og:url" content="http://localhost:4000/docs/MonteCarloProduction2016/" />
<meta property="og:site_name" content="Brendan Regnery" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-08-02T23:04:33+02:00" />
<script type="application/ld+json">
{"@context":"http://schema.org","@type":"WebPage","headline":"Monte Carlo Production with the 2016 CMS Scheme","datePublished":"2018-08-02T23:04:33+02:00","dateModified":"2018-08-02T23:04:33+02:00","description":"General Steps for Monte Carlo Production","url":"http://localhost:4000/docs/MonteCarloProduction2016/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="canonical" href="http://localhost:4000/docs/MonteCarloProduction2016/">
    <link rel="alternate" type="application/rss+xml" title="Brendan Regnery" href="http://localhost:4000/feed.xml" />
</head>


<body>

    <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container navbar-container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
            <a class="navbar-brand" href="/">
                <span><img src="/img/logonav.png"></span> Brendan Regnery
            </a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li  class="active" ><a href="/docs/home/">Research</a></li>
                <li ><a href="/cv/main/">CV</a></li>
                <li ><a href="/ecology/main/">Ecology</a></li>
                <li ><a href="/blog/2018/07/16/website/">Blog</a></li>
            </ul>
            <div class="navbar-right">
                <form class="navbar-form navbar-left">
                    <div class="form-group has-feedback">
                        <input id="search-box" type="text" class="form-control" placeholder="Search...">
                        <i class="fa fa-search form-control-feedback"></i>
                    </div>
                </form>
                <ul class="nav navbar-nav">
                    <li><a href="https://github.com/bregnery/bregnery.github.io"><i class="fa fa-github" aria-hidden="true"></i></a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>


    <div class="page-content">
        <div class="wrapper">
            <div class="container">
    <div class="row">
        <div class="col-md-4">
          <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">

  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-1" aria-expanded="false" aria-controls="collapse-1">
          My Research
        </a>
      </h4>
    </div>
    <div id="collapse-1" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
      <ul class="list-group">
        
          
          
          <a class="list-group-item " href="/docs/home/">Introduction</a>
        
      </ul>
    </div>
  </div>

  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-2" aria-expanded="false" aria-controls="collapse-2">
          Tutorials
        </a>
      </h4>
    </div>
    <div id="collapse-2" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
      <ul class="list-group">
        
          
          
          <a class="list-group-item active" href="/docs/MonteCarloProduction2016/">Monte Carlo Production with the 2016 CMS Scheme</a>
        
          
          
          <a class="list-group-item " href="/docs/FEWZtutorial/">FEWZ Tutorial</a>
        
      </ul>
    </div>
  </div>

  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-3" aria-expanded="false" aria-controls="collapse-3">
          Resources
        </a>
      </h4>
    </div>
    <div id="collapse-3" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
      <ul class="list-group">
        
          
          
          <a class="list-group-item " href="/docs/monteCarloProduction/">Resources for CMS Monte Carlo Production</a>
        
          
          
          <a class="list-group-item " href="/docs/cscIntroResources/">Introductory Resources for CSCs</a>
        
      </ul>
    </div>
  </div>

</div>

        </div>

        <div class="col-md-8">
            <h1>Monte Carlo Production with the 2016 CMS Scheme</h1>
            <div id="markdown-content-container"><h2 id="general-steps-for-monte-carlo-production">General Steps for Monte Carlo Production</h2>

<p>Monte Carlo simulations use statistical Monte Carlo methods on various physical models to predict the results of 
a particle collision and then simulate the detector response to those particles. For CMS, this is accomplished by
using programs like MadGraph and Pythia to calculate differential cross sections and final states, then passing the 
results to a program like GEANT which simulates the detector response. Most of this can be done using cmsdriver to 
create automated configuration files.</p>

<p>I preformed a Monte Carlo simulation with two main steps. First, I used MadGraph data cards as inputs for gridpack 
generation. Then, I used cmsdriver to generate configuration files that used pythia to finish the calculations and
GEANT to simulate the detector response. Additionally, cmsdriver converts the results of this simulation into the 
miniAOD file format.</p>

<h2 id="gridpack-creation">Gridpack Creation</h2>

<p>A gridpack is a tarball (compressed) file that contains a bunch of calculation results stored in away that can be 
read with cmsdriver. I have only produced gridpacks using MadGraph, but this can be done with other programs like 
PowHeg. A detailed guide for this, is the <a href="https://twiki.cern.ch/twiki/bin/viewauth/CMS/QuickGuideMadGraph5aMCatNLO">MadGraphGuide</a>. 
The Genproductions group is in charge of producing gridpacks that are requested by each physics group, their data 
cards are stored on <a href="https://github.com/cms-sw/genproductions/tree/pre2017">GitHub, genproductions</a></p>

<p>Producing a MadGraph gridpack requires four main files: <code class="highlighter-rouge">MC_proc_card.dat</code>, <code class="highlighter-rouge">MC_run_card.dat</code>, <code class="highlighter-rouge">MC_customizecards.dat</code> 
and <code class="highlighter-rouge">MC_extramodels.dat</code>. Examples of these files can be found on the Genproductions GitHub repository. These examples 
are excellent templates for making gridpacks. Gridpacks can then be produced locally or by submitting to a computing grid. 
Below is a tutorial based on how I created gridpacks.</p>

<h3 id="madgraph-gridpack-tutorial">MadGraph Gridpack Tutorial</h3>

<p>These programs should be run on CERN’s lxplus or Fermilab’s lpc. Gridpacks must be created outside of CMSSW and without 
cmsenv. To obtain the programs necessary for gridpack creation and some example data cards, please clone my GitHub
repository.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>git clone https://github.com/bregnery/MadGraphCardsForCMSSW
</code></pre>
</div>

<p>Now, permissions need to be updated in order to run shell scripts</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>chmod u+x gridpack_generation.sh
</code></pre>
</div>

<p>Then, update <code class="highlighter-rouge">gridpack_generation.sh</code> to make sure all fifo pipes are directed to /tmp director. Now, a gridpack can 
be generated using the desired data card.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>./gridpack_generation.sh &lt;name of process card without _proc_card.dat&gt; &lt;folder containing cards relative to current location&gt;
</code></pre>
</div>

<p>For example,</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>./gridpack_generation.sh Radion_hh_WWWW_jets_narrow_M3500 cards/Radion_hh_WWWW_jets_narrow_M3500/
</code></pre>
</div>

<h4 id="using-cluster-to-create-gridpacks">Using Cluster to Create Gridpacks</h4>

<p>To submit jobs on lxplus and store them locally, use the <code class="highlighter-rouge">submit_gridpack_generation_local.sh</code></p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>./submit_gridpack_generation_local.sh &lt;memory&gt; &lt;queue <span class="k">for </span>master job&gt; &lt;name of process card without _proc_card.dat&gt; &lt;folder containing cards relative to current location&gt; &lt;queue&gt;
</code></pre>
</div>

<p>For example,</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>./submit_gridpack_generation_local.sh 15000 2nw Radion_hh_WWWW_jets_narrow_M3500 cards/Radion_hh_WWWW_jets_narrow_M3500/ 8nh
</code></pre>
</div>

<h4 id="notes-about-creatingediting-data-cards">Notes about Creating/Editing Data Cards</h4>

<p>When creating or editing data cards, make sure to create four cards with the same name as your repository.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>&lt;repository&gt;_proc_card.dat
&lt;repository&gt;_run_card.dat
&lt;repository&gt;_customizecards.dat
&lt;repository&gt;_extramodels.dat
</code></pre>
</div>

<p>Make sure to list models needed in extra models if generating a sample with something other than the Standard Model. 
The number of events is listed listed in 
<code class="highlighter-rouge">run_card.dat</code>. When using the gridpacks <strong>DO NOT generate more events than what is listed in</strong> <code class="highlighter-rouge">run_card.dat</code>.</p>

<h2 id="from-gridpacks-to-miniaod">From Gridpacks to MiniAOD</h2>

<p>After creating (or obtaining) a gridpack, it must be converted into a MiniAOD sample. To obtain the proper workflow for 
your specific case, find similar Monte Carlo datasets on the <a href="https://cms-pdmv.cern.ch/mcm/">McM website</a>. Then click the 
icon that looks like a bar graph to view the work flow. Below are details for the 2016 Monte Carlo production process.</p>

<p>The work flow for the 2016 Monte Carlo production process is:</p>
<ol>
  <li>Gridpack (or pythia configuration with cmsdriver)</li>
  <li>GEN-SIM</li>
  <li>GEN-SIM-RAW</li>
  <li>AODSIM</li>
  <li>MiniAOD</li>
</ol>

<p>Each of the next steps involves using cmsdriver.py to generate configuration files that are then run with cmsRun. The 
commands to produce these files for various gridpacks are located on the <a href="https://cms-pdmv.cern.ch/mcm/">McM website</a>. 
To obtain the cmsdriver commands, click on the “Get Set Up commands”. You should record the commands for each PrepID in the 
work flow. For example, I used the Radion_hh_hVVbb MadGraph cards 
as a template, so I searched for the dataset “Radion_hh_hVVbb*” on McM to find and use the corresponding setup commands. For 
2016 Monte Carlo production, the setup commands can be found under the following PrepID’s:</p>

<ul>
  <li><strong>RunIISummer15wmLHEGS</strong> - These commands use a gridpack to produce GEN-SIM and LHE files</li>
  <li><strong>RunIISummer16DR80Premix</strong> - These commands use GEN-SIM files produce GEN-SIM-RAW files, add in pile-up, and then produce 
AODSIM files (along with an outdated MiniAOD file)</li>
  <li><strong>RunIISummer16MiniAODv2</strong> - These commands use AODSIM to produce the up-to-date MiniAOD files</li>
</ul>

<p>Make sure to change input files to the proper storage location. In particular, make sure that you are using the correct gridpack! 
For the step adding pile-up, I encountered some difficulties. DAS has recently changed their client, so the pile-up files will 
need to be manually entered into the cfg file. The tutorial below shows how I created the cmsdriver configuration
files.</p>

<h3 id="cmssw-cmsdriver-commands-tutorial">CMSSW cmsdriver Commands Tutorial</h3>

<p>Obtain the proper CMSSW release, clone this repository, and compile.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>cmsrel CMSSW_7_1_30
<span class="nb">cd </span>CMSSW_7_1_30/src/
git clone https://github.com/bregnery/hhMCgenerator.git
scram b
cmsenv
<span class="nb">cd </span>hhMCgenerator
</code></pre>
</div>

<p>Make sure to copy your gridpack into this directory. Now, obtain the proper python fragments (these should also be included
on the McM page).</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>curl -s --insecure https://cms-pdmv.cern.ch/mcm/public/restapi/requests/get_fragment/B2G-RunIISummer15wmLHEGS-01167 --retry 2 --create-dirs -o Configuration/GenProduction/python/B2G-RunIISummer15wmLHEGS-01167-fragment.py 
<span class="o">[</span> -s Configuration/GenProduction/python/B2G-RunIISummer15wmLHEGS-01167-fragment.py <span class="o">]</span>
scram b
</code></pre>
</div>

<p>Now modify the python fragment to input the proper grid pack. In 
<code class="highlighter-rouge">CMSSW_X_X_X/src/Configuration/Genproduction/python/B2G-RunIISummer15wmLHEGS-01167-fragment.py</code> line 5 should 
be altered to include the gridpack tarball file.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">args</span> <span class="o">=</span> <span class="n">cms</span><span class="o">.</span><span class="n">vstring</span><span class="p">(</span><span class="s">'&lt;gridpack_tarball&gt;.tar.xz'</span><span class="p">),</span>
</code></pre>
</div>

<p>Also make sure that the fragment contains a number of events less than or equal to the number of events used in the 
MadGraph cards that produced the gridpack.</p>

<p>Now, a cfg file can be produced using cmsdriver with the python fragment.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>cmsDriver.py Configuration/GenProduction/python/B2G-RunIISummer15wmLHEGS-01167-fragment.py --fileout file:B2G-RunIISummer15wmLHEGS-01167.root --mc --eventcontent RAWSIM,LHE --customise SLHCUpgradeSimulations/Configuration/postLS1Customs.customisePostLS1,Configuration/DataProcessing/Utils.addMonitoring --datatier GEN-SIM,LHE --conditions MCRUN2_71_V1::All --beamspot Realistic50ns13TeVCollision --step LHE,GEN,SIM --magField 38T_PostLS1 --python_filename B2G-RunIISummer15wmLHEGS-01167_1_cfg.py --no_exec -n 97
</code></pre>
</div>

<p>Then, use the configuration file to produce GEN-SIM and LHE files.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>scram b
cmsRun B2G-RunIISummer15wmLHEGS-01167_1_cfg.py
</code></pre>
</div>

<p>If the program runs correctly, you should have a .root file to use with the next step.</p>

<p>Production of GEN-SIM-RAW and AODSIM files requires CMSSW_8_0_21.
Obtain this CMSSW release, clone this repository, and compile.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>cmsrel CMSSW_8_0_21
<span class="nb">cd </span>CMSSW_8_0_21/src/
git clone https://github.com/bregnery/hhMCgenerator.git
scram b
cmsenv
<span class="nb">cd </span>hhMCgenerator
</code></pre>
</div>

<p>Make sure to copy your GEN-SIM and LHE files from the previous step to the new directory.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>cp &lt;your_path&gt;/CMSSW_7_1_30/src/hhMCgenerator/B2G-RunIISummer15wmLHEGS-01167_inLHE.root .
cp &lt;your_path&gt;/CMSSW_7_1_30/src/hhMCgenerator/B2G-RunIISummer15wmLHEGS-01167.root .
</code></pre>
</div>

<p>Now, another cfg file can be produced using cmsdriver. Note that the DAS client has changed so you will need to copy the pile up files from <code class="highlighter-rouge">B2G-RunIISummer16DR80Premix-01267_1_cfg.py</code>.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>cmsDriver.py step1 --fileout file:Radion_hh_wwwww_M3500_GEN-SIM-RAW.root  --pileup_input <span class="s2">"dbs:/Neutrino_E-10_gun/RunIISpring15PrePremix-PUMoriond17_80X_mcRun2_asymptotic_2016_TrancheIV_v2-v2/GEN-SIM-DIGI-RAW"</span> --mc --eventcontent PREMIXRAW --datatier GEN-SIM-RAW --conditions 80X_mcRun2_asymptotic_2016_TrancheIV_v6 --step DIGIPREMIX_S2,DATAMIX,L1,DIGI2RAW,HLT:@frozen2016 --nThreads 4 --datamix PreMix --era Run2_2016 --python_filename B2G-RunIISummer16DR80Premix-01267_1_cfg.py --no_exec --customise Configuration/DataProcessing/Utils.addMonitoring -n 97

cmsDriver.py step2 --filein file:Radion_hh_wwwww_M3500_GEN-SIM-RAW.root --fileout file:B2G-RunIISummer16DR80Premix-Radion_hh_wwww_M3500_AODSIM.root --mc --eventcontent AODSIM --runUnscheduled --datatier AODSIM --conditions 80X_mcRun2_asymptotic_2016_TrancheIV_v6 --step RAW2DIGI,RECO,EI --nThreads 4 --era Run2_2016 --python_filename B2G-RunIISummer16DR80Premix-AODSIM_2_cfg.py --no_exec --customise Configuration/DataProcessing/Utils.addMonitoring -n 97
</code></pre>
</div>

<p>Now, use the configuration file to produce GEN-SIM-RAW.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>scram b
cmsRun B2G-RunIISummer16DR80Premix-01267_1_cfg.py
</code></pre>
</div>

<p>If the program was successful the output will be Radion_hh_wwwww_M3500_GEN-SIM-RAW.root. Then, use the next configuration file to produce AODSIM.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>scram b
cmsRun B2G-RunIISummer16DR80Premix-AODSIM_2_cfg.py
</code></pre>
</div>

<p>Now, there should be <code class="highlighter-rouge">B2G-RunIISummer16DR80Premix-Radion_hh_wwww_M3500_AODSIM.root</code></p>

<p>Next, create the last cfg file using cmsdriver.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>cmsDriver.py step1 --fileout file:Radion_hh_wwww_M3500_MiniAOD.root --mc --eventcontent MINIAODSIM --runUnscheduled --datatier MINIAODSIM --conditions 80X_mcRun2_asymptotic_2016_TrancheIV_v6 --step PAT --nThreads 4 --era Run2_2016 --python_filename B2G-RunIISummer16MiniAODv2_Radion_hh_wwww_M3500-MiniAOD_1_cfg.py --no_exec --customise Configuration/DataProcessing/Utils.addMonitoring -n 82
</code></pre>
</div>

<p>Now use the configuration file to produce MiniAOD.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>scram b
cmsRun B2G-RunIISummer16MiniAODv2_Radion_hh_wwww_M3500-MiniAOD_1_cfg.py
</code></pre>
</div>

<p>If the whole process was successful, the output should be <code class="highlighter-rouge">Radion_hh_wwww_M3500_MiniAOD.root</code>.</p>

<h2 id="remarks">Remarks</h2>

<p>After creating the necessary configuration files using cmsdriver, I created a work flow that utilized crab and stored the simulation files
on the LPC using EOS. This is documented on my <a href="https://github.com/bregnery/hhMCgenerator">hhMCgenerator repository</a>.</p>

</div>
            <p class="text-center">
              <br />
              <a target="_blank" href="https://github.com/bregnery/bregnery.github.io/tree/master/_docs/tutorials/MonteCarloProduction2016.md" class="btn btn-default githubEditButton" role="button">
                <i class="fa fa-pencil fa-lg"></i> Improve this page
              </a>
            </p>
            <hr>
            





  
  

  
  
    <ul class="pager">
      
        
        
        <li class="previous">
          <a href="/docs/home/">
            <span aria-hidden="true">&larr;</span> Previous
          </a>
        </li>
      

      
        
        
        <li class="next">
          <a href="/docs/FEWZtutorial/">
            Next <span aria-hidden="true">&rarr;</span>
          </a>
        </li>
      
    </div>
    <div class="clear"></div>
    

        </div>

    </div>
</div>

        </div>
    </div>

    <footer class="footer">
    <div class="container">

        <p class="text-center">
            Brendan Regnery 2018 |
            Powered by <a href="https://github.com/aksakalli/jekyll-doc-theme">Jekyll Doc Theme</a>
        </p>
        <!-- <p class="text-muted">Place sticky footer content here.</p> -->
    </div>
</footer>

    <script>
  var baseurl = ''
</script>
<script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="/js/bootstrap.min.js "></script>
<script src="/js/typeahead.bundle.min.js "></script>

<script src="/js/main.js "></script>

</body>

</html>
